clc;
clear all;

%% tube definition from outer to inner
link_nbr = 4;
% command (stroke(mm), angle(rad))
diam = [2.184; 2.184; 1.524; 1.2];  % outer diameter of section 1 to 4
%% optimize length3
Length1 = [ 1.15253386  1.07612094 42.91521194  6.67349813 35.68288201 18.6322818...
  1.02549054 12.75548719 30.16100144 26.56833513];
Length2 = [2.42754769e+01 2.68261980e-02 8.66589000e+00 3.40460558e+01...
 6.48585812e-03 1.47537074e+01 2.46072744e+01 3.99161078e-01...
 6.59764298e+00 6.79149465e+00];
Length3 = [52.44475674 68.25135741 24.01243534  1.0939399  47.66036807 34.19589988...
 61.52835028 72.24201854 32.08232315 43.39084922];
Length4 = [13.11716499 14.74626406 10.01140013 48.12263183  1.00028616 20.22188509...
  6.60007905  1.82624281 15.5626817   9.56151557];
kappa2 =  0.0507077;
kb1 =  3.94359409;
kb2 =  6.54065841;
kb3 =  27.77643823;
l22 =  [76.72023365 68.2781836  32.67832534 35.13999573 47.66685393 48.94960723...
 86.1356247  72.64117961 38.67996613 50.18234387];
psi2 =  [5.48398489e+07 1.48889948e-01 6.14135512e+06 4.15670673e+05...
 1.36732043e+07 3.14667076e+07 2.51689972e-01 3.43023940e-01...
 1.98975457e-29 3.21104702e+06];
%% optimize length2
% Length1 = [47.29407817 43.68951276 49.40536642 41.58983681 44.38272951 42.911149...
%  40.28675753 40.52216501 44.70188606 39.13140318];
% Length3 = [1.55001051e+01 3.93352646e+00 5.28634958e-03 4.20949691e+00...
%  2.15464613e+01 1.58191160e+01 9.08133414e+00 2.25626947e+01...
%  3.26679141e+01 8.68743408e+00];
% Length2 = [12.52228456 10.23098813 12.04699454 11.99490751  9.04770093 11.07376684...
%  18.74442622 12.81706363  5.23664538 13.69656905];
% Length4 = [13.1202483  26.31906387 24.41807042 27.68318022 10.3580293  16.48735556...
%  25.68609121 12.83729448  1.0037692  25.83050343];
% kappa2 =  0.07855184;
% kb1 =  2.21975998;
% kb2 =  2.22073374;
% kb3 =  27.81692869;
% l22 =  [28.02238967 14.16451459 12.05228088 16.20440441 30.59416226 26.89288286...
%  27.82576036 35.37975837 37.90455945 22.38400313];
% psi2 =  [0.16514868 0.14888995 0.15865526 0.26625205 0.29544084 0.32175055...
%  0.25168997 0.34302394 0. 0.03844259];
Length1 = [37.64463873 37.14046865 42.95108596 39.58855016 41.49968635 51.51460045...
 27.74159532 22.52650309 22.36430203 34.46208667];
Length3 = [19.49173197 27.51278082 22.59007148 29.32103952 29.80041164 25.24999264...
 26.24780156 47.46402793 32.49456323 33.75850607];
Length2 = [12.64169963  1.00215665  5.68720362  1.00331741  1.          1.96240986...
 17.71969955  1.00000003  4.00626159  2.15174542];
Length4 = [19.12668622 18.10543155 14.33860024 14.59490109 12.53807152  6.05744239...
 22.26500079 17.53992966 26.15343876 15.74564298];
kappa2 =  0.05809854;
kb1 =  22.38325214;
kb2 =  22.41117053;
kb3 =  49.99999895
l22 =  [32.1334316  28.51493747 28.2772751  30.32435693 30.80041164 27.2124025...
 43.96750112 48.46402796 36.50082482 35.91025149];
psi2 =  [1.65148677e-01 1.48889948e-01 1.58655262e-01 2.66252049e-01...
 2.95440837e-01 3.21750554e-01 2.51689972e-01 3.43023940e-01...
 7.74253878e-37 3.84425900e-02];
%%
Length1 = [70.82326201 66.9397232  70.98153566 72.79400632 72.00421012 73.12785056...
 66.82849289 70.82480459 78.22888465 80.98341006];
Length3 = [11.88381102  9.07088808  2.59097745  7.71952366  9.31459042  7.80627145...
 11.83660851  8.68115564  2.05897288  0.83750959];
Length2 = [1.86489568 1.06400104 4.31656768 1.76734486 1.45706029 2.21780102...
 3.53012486 2.96970704 6.47747434 7.058768  ];
Length4 = [1.51500914 5.77725535 6.52866298 1.11577014 1.         1.02137772...
 7.02452213 3.47416543 2.42363942 1.00727953];
kappa2 =  0.12453515;
kb1 =  11.08293629;
kb2 =  12.83448456;
kb3 =  43.08328843;
l22 =  [13.7487067  10.13488912  6.90754513  9.48686852 10.77165071 10.02407247...
 15.36673337 11.65086268  8.53644723  7.89627759];
psi2 =  [1.65148677e-01 1.48889948e-01 1.58655262e-01 2.66252049e-01...
 2.95440837e-01 3.21750554e-01 2.51689972e-01 3.43023940e-01...
 8.01096099e-30 2.49947936e-02];
%%
Length1 = [61.82902488 68.98452744 80.60143345 79.76547425 80.53984521 66.65385177...
 82.13106898 78.52795619 54.16309853 85.68730071];
Length3 = [3.09886702 0.79020948 0.33375661 0.45612466 0.98612847 0.87408838...
 0.275308   0.92181437 0.03840596 0.95964897];
Length2 = [1.08522528 1.15648124 1.50065025 1.28664632 1.09002371 1.58377626...
 2.22817868 1.55976858 3.89510207 2.04191296];
Length4 = [21.63311727 12.04900059  1.58460362  1.77606016  1.         15.76274187...
  3.56782531  4.72310743 36.50188737  1.00220683];
kappa2 =  0.37501333;
kb1 =  11.29425977;
kb2 =  11.55393517;
kb3 =  23.06594995;
l22 =  [4.18409229 1.94669073 1.83440686 1.74277099 2.07615218 2.45786464
 2.50348668 2.48158296 3.93350802 3.00156193];
psi2 =  [1.65148677e-01 1.48889948e-01 1.58655262e-01 2.66252049e-01...
 2.95440837e-01 3.21750554e-01 2.51689972e-01 3.43023940e-01...
 3.94430453e-41 2.49947936e-02];
%%

Length1 = [34.51841637 30.20009608 52.29830476 47.05355015 49.63606184 14.04291581...
 28.08149911 26.47465143 41.63600881 76.567363  ];
Length3 = [19.16096369  9.331343    0.          0.          0.         35.29876891...
 32.74448446 74.78072987 21.55380081  2.24433665];
Length2 = [1.         1.         1.         1.         1.         1. ...
 1.00129837 8.5800383  1.         1.00314597];
Length4 = [38.16495717 46.32569146 33.14506865 37.74777383 35.48140661 41.39340937...
 36.77337546  8.99386513 32.8731802  11.3208563 ];
kappa2 =  1;
kb1 =  1;
kb2 =  1;
kb3 =  50;
l22 =  [20.16096369 10.331343    1.          1.          1.         36.29876891...
 33.74578282 83.36076817 22.55380081  3.24748262];
psi2 =  [1.65148677e-01 1.48889948e-01 1.58655262e-01 2.66252049e-01...
 2.95440837e-01 3.21750554e-01 2.51689972e-01 3.43023940e-01...
 7.87922208e-33 2.49947936e-02];
%%
Length1 = [74.47494997 75.51668943 76.4604888  77.30042862 78.03091028 78.64724007...
 79.14542058 79.52195456 79.77452306 79.90121319 79.90121319 79.77452306...
 79.52205205 79.14541629 78.64723457 78.03091028 77.3004207  76.46058549...
 75.51677561 74.47504614];
Length3 = [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.];
Length2 = [9.13960823 8.9372268  8.75116396 8.58332645 8.43554395 8.30948815...
 8.20665549 8.12834549 8.07554486 8.0489691  8.0489691  8.07554486...
 8.12833569 8.20665297 8.30948497 8.43554395 8.58332202 8.75115307...
 8.93721005 9.13959659];
Length4 = [1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.];
kappa2 =  0.07002202;
kb1 =  1.00011659;
kb2 =  7.38282264;
kb3 =  80;
l22 =  [9.13960823 8.9372268  8.75116396 8.58332645 8.43554395 8.30948815...
 8.20665549 8.12834549 8.07554486 8.0489691  8.0489691  8.07554486...
 8.12833569 8.20665297 8.30948497 8.43554395 8.58332202 8.75115307...
 8.93721005 9.13959659];
psi2 =  [-0.33104465 -0.3058157  -0.27773395 -0.24695651 -0.21368223 -0.17816316...
 -0.1407065  -0.10167567 -0.06148241 -0.0205746   0.0205746   0.06148241...
  0.10167567  0.14070405  0.17816074  0.21368223  0.24695416  0.27773395...
  0.30581342  0.33104465];
%%
Length1 = [74.47758366 75.51926528 76.46301148 77.30290334 78.03334279 78.64963656...
 79.14778768 79.52429928 79.77685269 79.90353522 79.90353522 79.77685269...
 79.52439678 79.1477834  78.64963106 78.03334279 77.30289543 76.46310817...
 75.51935145 74.47767982];
Length3 = [-1.77635684e-15  0.00000000e+00  0.00000000e+00  0.00000000e+00...
  1.77635684e-15  0.00000000e+00  0.00000000e+00  0.00000000e+00...
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00...
  0.00000000e+00  1.77635684e-15  0.00000000e+00  1.77635684e-15...
  0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00];
Length2 = [9.13683834 8.93452352 8.74852156 8.58073869 8.4330041  8.30698902...
 8.20418947 8.12590464 8.07312095 8.0465537  8.0465537  8.07312095...
 8.12589484 8.20418696 8.30698584 8.4330041  8.58073427 8.74851067...
 8.93450677 9.13682671];
Length4 = [1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.];
kappa2 =  0.07923268;
kb1 =  1.654;
kb2 =  5.8146;
kb3 =  70.3552;
l22 =  [9.13683834 8.93452352 8.74852156 8.58073869 8.4330041  8.30698902...
 8.20418947 8.12590464 8.07312095 8.0465537  8.0465537  8.07312095...
 8.12589484 8.20418696 8.30698584 8.4330041  8.58073427 8.74851067...
 8.93450677 9.13682671];
psi2 =  [-0.33104465 -0.3058157  -0.27773395 -0.24695651 -0.21368223 -0.17816316...
 -0.1407065  -0.10167567 -0.06148241 -0.0205746   0.0205746   0.06148241...
  0.10167567  0.14070405  0.17816074  0.21368223  0.24695416  0.27773395...
  0.30581342  0.33104465];
%%
% l = [15.26815916;24.23327281;1.12428232; 16.58561056];                   % length of section 1 to 4
% psi2 = 0.16514868;
% 
% kappa2 = 1.0079047;
% kb1 =1.00186171;
% kb2 =  1.00478747;
% kb3 =  17.8372724;
curv3 = (kappa2*kb2)/(kb1 + kb2 + kb3);
curv2 = (kappa2*kb2)/(kb1 + kb2);
gamma = [0; curv3; curv2; 0];             % curvature of section 1 to 4


% T = [cos(psi2) -sin(psi2) 0 0;
%        sin(psi2) cos(psi2) 0 0;
%        0 0 1 0;
%        0 0 0 1];
%T = [1 0 0 0; 0 1 0 0; 0 0 1 0; 0 0 0 1]; % intial transformation matrix

couleurs = fliplr(hsv(link_nbr));   % creates a panel of tube_nbr colors
figure,
 for p=1:size(Length3,2)
    l = [Length4(p) Length3(p) Length2(p) Length1(p)];
    T = [cos(psi2(p)) -sin(psi2(p)) 0 0;
       sin(psi2(p)) cos(psi2(p)) 0 0;
       0 0 1 0;
       0 0 0 1];
   
    
    for i=1:link_nbr
        angle_eq = 0;
        %% plot tube portion
        q = linspace(0,2*pi,100);
        % base_i = diam(1,find(tube_flag,1,'last'))/2*[cos(q); sin(q)]; % Base curve is a circle
        base_o = diam(i)/2*[cos(q); sin(q)];
        if (gamma(i)==0)
            q = linspace(0,l(i),50);
            path = T(1:3,1:3)*[linspace(0,0,size(q,2)); linspace(0,0,size(q,2)); q] + repmat(T(1:3,4),[1 size(q,2)]); % Trajectory is a straight line
        else
            q = linspace(0,l(i)*gamma(i),50);
            path = T(1:3,1:3)*[cos(angle_eq)*(1-cos(q))/gamma(i); sin(angle_eq)*(1-cos(q))/gamma(i); sin(q)/gamma(i)] + repmat(T(1:3,4),[1 size(q,2)]); % Trajectory is an arc
        end
        % draw external surface of tube
        [Xo,Yo,Zo]=extrude(base_o,path);
        surface_o = surf(Xo,Yo,Zo); axis equal;
        set(surface_o,'FaceColor',couleurs(i,:),'EdgeColor','none');
        hold on
        xlabel('x'); ylabel('y'); zlabel('z'); % axis label
        title('kappa2=1, lower=1,upper bound = 50')

        %% matrix of homogenious coordinates
        if (gamma(i)==0)
            T = T*[1 0 0 0;
                0 1 0 0;
                0 0 1 l(i);
                0 0 0 1]; % homogenious coordinates in case of straight portion
        else
            T = T*[cos(angle_eq)^2*(cos(gamma(i)*l(i))-1)+1 sin(angle_eq)*cos(angle_eq)*(cos(gamma(i)*l(i))-1) cos(angle_eq)*sin(gamma(i)*l(i)) cos(angle_eq)/gamma(i)*(1-cos(gamma(i)*l(i)));
                sin(angle_eq)*cos(angle_eq)*(cos(gamma(i)*l(i))-1) cos(angle_eq)^2*(1-cos(gamma(i)*l(i)))+cos(gamma(i)*l(i)) sin(angle_eq)*sin(gamma(i)*l(i)) sin(angle_eq)/gamma(i)*(1-cos(gamma(i)*l(i)));
                -cos(angle_eq)*sin(gamma(i)*l(i)) -sin(angle_eq)*sin(gamma(i)*l(i)) cos(gamma(i)*l(i)) sin(gamma(i)*l(i))/gamma(i);
                0 0 0 1]; % homogenious coordinates in case of curved portion
        end
    end
 end